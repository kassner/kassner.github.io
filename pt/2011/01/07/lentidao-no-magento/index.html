<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta charset="UTF-8"><title>Lentidão no Magento | Rafael Kassner</title><meta name="robots" content="index,follow"/><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://www.kassner.com.br/atom.xml"/><link rel="canonical" href="https://www.kassner.com.br/pt/2011/01/07/lentidao-no-magento/"/><link rel="stylesheet" href="https://www.kassner.com.br/assets/css/main.css"/></head><body class="post"><div class="background"></div><div id="wrapper"> <header> <nav id="site-navigation" class="main-navigation" role="navigation"> <label for="drop" class="toggle">Menu</label> <input type="checkbox" id="drop"/><ul id="primary-menu" class="menu"><li class="menu-item"><a href="https://www.kassner.com.br">Rafael Kassner</a></li><li class="menu-item"><a href="https://www.kassner.com.br/projects/">Projects</a></li><li class="menu-item"><a href="https://www.kassner.com.br/about/">About</a></li></ul> </nav> </header><div class="pull-down"></div><div class="container"><div id="primary" class="content-area"> <main id="main" class="site-main" role="main"> <article lang="en" class="post type-post status-publish format-standard hentry"><h1 class="article-header"><a href="https://www.kassner.com.br/pt/2011/01/07/lentidao-no-magento/">Lentidão no Magento</a></h1><div class="entry-meta"><div class="byline"> <span class="posted-on"><time class="entry-date published" datetime="2011-01-07T00:00:00+00:00">2011-01-07</time></span> <span class="language">Português</span></div></div><div class="entry-content"><p>Olá.</p><p>Após um exaustivo trabalho de debug no Magento, o <a href="http://www.ibaldo.com.br/">Filipe Ibaldo</a> e eu acabamos por descobrir dois problemas no Magento, relacionados à lentidão na conclusão da compra com muitos produtos (produtos diferentes, e não um produto com 100 unidades).</p><p>Um dos problemas é o save de cada produto que está no Order, que é executado precisamente em app/code/core/Mage/Sales/Model/Entity/Order/Attribute/Backend/Parent.php, no método afterSave, que demanda MUITO tempo de processamento na minha máquina (Core 2 Duo 2.26/4GB RAM), cerca de 0.3 segundos para cada produto.</p><p>Levando em consideração que os clientes deste determinado eCommerce compram, em média, mais de 50 produtos diferentes por compra, esse tempo, somado a outras execuções e server load bastante alto, ultrapassa 1 minuto para efetuar o fechamento da compra, um valor inaceitável.</p><p>A solução encontrada foi desabilitar os observers que executam após esse salvamento, que são do Mage_Downloadable e do Mage_Rss:</p><p>Em <code class="language-plaintext highlighter-rouge">app/code/core/Mage/Downloadable/etc/config.xml</code>, remova/comente as seguintes linhas:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;sales_order_item_save_commit_after&gt;</span>
    <span class="nt">&lt;observers&gt;</span>
        <span class="nt">&lt;downloadable_observer&gt;</span>
            <span class="nt">&lt;class&gt;</span>downloadable/observer<span class="nt">&lt;/class&gt;</span>
            <span class="nt">&lt;method&gt;</span>saveDownloadableOrderItem<span class="nt">&lt;/method&gt;</span>
        <span class="nt">&lt;/downloadable_observer&gt;</span>
    <span class="nt">&lt;/observers&gt;</span>
<span class="nt">&lt;/sales_order_item_save_commit_after&gt;</span>
</code></pre></div></div><p>O trecho de código acima aparece duas vezes.</p><p>Em <code class="language-plaintext highlighter-rouge">app/code/core/Mage/Rss/etc/config.xml</code>, remova/comente as seguintes linhas:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;sales_order_save_after&gt;</span>
    <span class="nt">&lt;observers&gt;</span>
        <span class="nt">&lt;notifystock&gt;</span>
            <span class="nt">&lt;class&gt;</span>rss/observer<span class="nt">&lt;/class&gt;</span>
            <span class="nt">&lt;method&gt;</span>salesOrderItemSaveAfterNotifyStock<span class="nt">&lt;/method&gt;</span>
        <span class="nt">&lt;/notifystock&gt;</span>
    <span class="nt">&lt;/observers&gt;</span>
<span class="nt">&lt;/sales_order_save_after&gt;</span>
<span class="nt">&lt;sales_order_save_after&gt;</span>
    <span class="nt">&lt;observers&gt;</span>
        <span class="nt">&lt;ordernew&gt;</span>
            <span class="nt">&lt;class&gt;</span>rss/observer<span class="nt">&lt;/class&gt;</span>
            <span class="nt">&lt;method&gt;</span>salesOrderItemSaveAfterOrderNew<span class="nt">&lt;/method&gt;</span>
        <span class="nt">&lt;/ordernew&gt;</span>
    <span class="nt">&lt;/observers&gt;</span>
<span class="nt">&lt;/sales_order_save_after&gt;</span>
</code></pre></div></div><p>Feito isso, o tempo do save de cada produto passou de 0.3 segundos para 0.001 segundos, um ganho incrível de velocidade no geral.</p><p>Entretanto, vale ressaltar que se você estiver utilizando produtos “baixáveis” ou controle de estoque pelo Magento, essas alterações podem trazer problemas ao sistema, portanto, execute com cuidado a alteração.</p><p>Outro problema encontrado por nós foi relacionado com o recurso de desabilitar módulos do Magento, disponível no admin em Sistema &gt; Configuração &gt; Avançado &gt; Avançado &gt; Desabilitar saída dos módulos, o qual, mesmo estando o Mage_Rss e o Mage_Downloadable desabilitados, seus observers continuaram funcionando, sendo necessário remover a pasta do módulo (ou a configuração) para o mesmo parar de funcionar totalmente.</p><p>Até mais.</p></div><div class="entry-footer"><p class="cat-links">Posted in <a href="/tags/php/" rel="tag">php</a>, <a href="/tags/magento/" rel="tag">magento</a>, <a href="/tags/performance/" rel="tag">performance</a></p></div> </article> </main></div></div></div><footer><div class="footer-content"></div><div class="footer"><div><div> <span class="copy">Copyright © 2010-2021 Rafael Kassner</span></div></div></div> </footer></body></html>