<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta charset="UTF-8"><title>Magento: conflito de rotas entre frontend e admin | Rafael Kassner</title><meta name="robots" content="index,follow"/><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://www.kassner.com.br/atom.xml"/><link rel="canonical" href="https://www.kassner.com.br/pt/2014/06/06/magento-conflito-de-rotas-entre-frontend-e-admin/"/><link rel="stylesheet" href="https://www.kassner.com.br/assets/css/main.css"/></head><body class="post"><div class="background"></div><div id="wrapper"> <header> <nav id="site-navigation" class="main-navigation" role="navigation"> <label for="drop" class="toggle">Menu</label> <input type="checkbox" id="drop"/><ul id="primary-menu" class="menu"><li class="menu-item"><a href="https://www.kassner.com.br">Rafael Kassner</a></li><li class="menu-item"><a href="https://www.kassner.com.br/projects/">Projects</a></li><li class="menu-item"><a href="https://www.kassner.com.br/about/">About</a></li></ul> </nav> </header><div class="pull-down"></div><div class="container"><div id="primary" class="content-area"> <main id="main" class="site-main" role="main"> <article lang="en" class="post type-post status-publish format-standard hentry"><h1 class="article-header"><a href="https://www.kassner.com.br/pt/2014/06/06/magento-conflito-de-rotas-entre-frontend-e-admin/">Magento: conflito de rotas entre frontend e admin</a></h1><div class="entry-meta"><div class="byline"> <span class="posted-on"><time class="entry-date published" datetime="2014-06-06T00:00:00+00:00">2014-06-06</time></span> <span class="language">Português</span></div></div><div class="entry-content"><p>Hoje eu estava trabalhando num bug de um módulo de terceiros. Algo simples, o botão do adicionar ao carrinho fazia seu trabalho por AJAX, ao invés do tradicional POST. Entretanto, toda vez que eu chamava a URL <code class="language-plaintext highlighter-rouge">http://.../ajaxcart/cart/add</code>, eu recebia um HTTP status 302, ou seja, um redirecionamento, para a mesma URL, porém em modo seguro (HTTPS).</p><p>Depois de um processo de debug, constatei que o controller não era chamado quando era feita a requisição, portanto o problema deveria estar em alguma configuração do Magento. E de fato, estava. O painel administrativo estava configurado para utilizar o HTTPS (Configurações &gt; Geral &gt; Web &gt; Seguro &gt; Usar SSL no Admin), e quando eu removia esta opção, tudo funcionava conforme o esperado.</p><p>No final de contas, o problema era esse:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;frontend&gt;</span>
        <span class="nt">&lt;routers&gt;</span>
            <span class="nt">&lt;ajaxcart&gt;</span>
                <span class="nt">&lt;use&gt;</span>standard<span class="nt">&lt;/use&gt;</span>
                <span class="nt">&lt;args&gt;</span>
                    <span class="nt">&lt;module&gt;</span>Empresa_AjaxCart<span class="nt">&lt;/module&gt;</span>
                    <span class="nt">&lt;frontname&gt;</span>ajaxcart<span class="nt">&lt;/frontname&gt;</span>
                <span class="nt">&lt;/args&gt;</span>
            <span class="nt">&lt;/routename&gt;</span>
        <span class="nt">&lt;/routers&gt;</span>
    <span class="nt">&lt;/frontend&gt;</span>
    <span class="nt">&lt;admin&gt;</span>
        <span class="nt">&lt;routers&gt;</span>
            <span class="nt">&lt;ajaxcart&gt;</span>
                <span class="nt">&lt;use&gt;</span>admin<span class="nt">&lt;/use&gt;</span>
                <span class="nt">&lt;args&gt;</span>
                    <span class="nt">&lt;module&gt;</span>Empresa_AjaxCart<span class="nt">&lt;/module&gt;</span>
                    <span class="nt">&lt;frontname&gt;</span>ajaxcart<span class="nt">&lt;/frontname&gt;</span>
                <span class="nt">&lt;/args&gt;</span>
            <span class="nt">&lt;/routename&gt;</span>
        <span class="nt">&lt;/routers&gt;</span>
    <span class="nt">&lt;/admin&gt;</span>
</code></pre></div></div><p>Percebam acima que nas duas situações, o <code class="language-plaintext highlighter-rouge">frontname</code> é o mesmo. Desta forma, toda vez que era acessada uma url no padrão <code class="language-plaintext highlighter-rouge">http://.../ajaxcart/*</code>, o Magento mandava uma resposta ao navegador para redirecionar para o modo seguro. No caso de um AJAX, isso traz dois problemas:</p><ol><li>Geralmente os desenvolvedores não se preocupam com outros status diferentes de 200 numa requisição AJAX;</li><li>É necessário configurar a política conhecida como <code class="language-plaintext highlighter-rouge">Same-Origin Policy</code>, ou ainda os famosos erros de <code class="language-plaintext highlighter-rouge">CORS</code>, tal qual o Firefox informa:</li></ol><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Cross-Origin Request Blocked: The Same Origin Policy disallows reading the remote resource at https://.../ajaxcart/cart/add/. This can be fixed by moving the resource to the same domain or enabling CORS.
</code></pre></div></div><p>Portanto, fica a dica, sempre que forem desenvolver módulos que tenham controllers tanto no frontend quanto no admin, atentem-se para não utilizar o mesmo frontname nas rotas.</p><p>Até mais!</p></div><div class="entry-footer"><p class="cat-links">Posted in <a href="/tags/magento/" rel="tag">magento</a>, <a href="/tags/php/" rel="tag">php</a>, <a href="/tags/redirect/" rel="tag">redirect</a>, <a href="/tags/http/" rel="tag">http</a></p></div> </article> </main></div></div></div><footer><div class="footer-content"></div><div class="footer"><div><div> <span class="copy">Copyright © 2010-2021 Rafael Kassner</span></div></div></div> </footer></body></html>