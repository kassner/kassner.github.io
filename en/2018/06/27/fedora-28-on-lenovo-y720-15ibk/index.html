<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta charset="UTF-8"><title>Fedora 28 on Lenovo Y720-15IBK | Rafael Kassner</title><meta name="robots" content="index,follow"/><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://www.kassner.com.br/atom.xml"/><link rel="canonical" href="https://www.kassner.com.br/en/2018/06/27/fedora-28-on-lenovo-y720-15ibk/"/><link rel="stylesheet" href="https://www.kassner.com.br/assets/css/main.css"/></head><body class="post"><div class="background"></div><div id="wrapper"> <header> <nav id="site-navigation" class="main-navigation" role="navigation"> <label for="drop" class="toggle">Menu</label> <input type="checkbox" id="drop"/><ul id="primary-menu" class="menu"><li class="menu-item"><a href="https://www.kassner.com.br">Rafael Kassner</a></li><li class="menu-item"><a href="https://www.kassner.com.br/projects/">Projects</a></li><li class="menu-item"><a href="https://www.kassner.com.br/about/">About</a></li></ul> </nav> </header><div class="pull-down"></div><div class="container"><div id="primary" class="content-area"> <main id="main" class="site-main" role="main"> <article lang="en" class="post type-post status-publish format-standard hentry"><h1 class="article-header"><a href="https://www.kassner.com.br/en/2018/06/27/fedora-28-on-lenovo-y720-15ibk/">Fedora 28 on Lenovo Y720-15IBK</a></h1><div class="entry-meta"><div class="byline"> <span class="posted-on"><time class="entry-date published" datetime="2018-06-27T00:00:00+00:00">2018-06-27</time></span> <span class="language">English</span></div></div><div class="entry-content"><p>It’s almost a year since I purchased this gaming computer and just now I had the need to do anything else than gaming in it. I have a friend that recently bought a notebook with a Nvidia GTX 1060 and he installed Fedora, making it a very snappy workstation, so I decided to give Fedora a go again. My computer came with Windows 10 by default and I never changed anything there, so here I am writing down all knowledge I got from installing Fedora in this machine.</p><h2 id="partitioning">Partitioning</h2><p>Partitioning the disk using the Windows disk management tool worked just fine.</p><h2 id="live-usb">Live USB</h2><p>Fedora Media Writer for Windows worked as intended.</p><h2 id="rebooting-into-the-live-usb">Rebooting into the Live USB</h2><p>Two tricky things. First one is <a href="https://www.windowscentral.com/how-disable-windows-10-fast-startup">disable Fastboot</a>. The second one is that even disabling it on Windows, I still couldn’t get into my BIOS. I had to click on restart while holding shift and then use the Windows repair menu to get into the BIOS. Once inside the BIOS, I disabled the Fastboot and also allowed the boot over USB that was needed. Figuring out how to make into the BIOS took me some time also, but somehow I learned that I should use <code class="language-plaintext highlighter-rouge">Fn + F2</code> for the BIOS and <code class="language-plaintext highlighter-rouge">Fn + F12</code> for the boot menu.</p><h2 id="disk-not-recognized">Disk not recognized</h2><p>Booting into the Live USB was fine, but the installer could not recognize my NVMe disk at all. After a lot of research I landed into this tip that was to set the <code class="language-plaintext highlighter-rouge">Sata Controller Mode</code> to <code class="language-plaintext highlighter-rouge">AHCI</code>. I had <code class="language-plaintext highlighter-rouge">Intel RST Premium</code> configured there and doing the change, Fedora was able to find my disk.</p><p>Sadly, I could not get back to Windows with that configuration. Selecting Windows on GRUB will reboot the computer and start attempt to load Windows, but eventually I get an Windows-like error message saying that was not possible to boot. The error code was <code class="language-plaintext highlighter-rouge">INACCESSIBLE_BOOT_DEVICE</code>.</p><p>It took me a couple of hours investigating just this issue until I managed to make it work. I had to <a href="http://support.thinkcritical.com/kb/articles/switch-windows-10-from-raid-ide-to-ahci">Switch Windows 10 from RAID/IDE to AHCI</a>, but I struggled a bit because I was doing that from the Repair tool instead of loading Windows normally. After I gave it a go from scratch, it worked as expected. Now I have dual boot on GRUB for Fedora and Windows, and my <code class="language-plaintext highlighter-rouge">Sata Controller Mode</code> is set to <code class="language-plaintext highlighter-rouge">AHCI</code>.</p><h2 id="nvidia-driver">NVidia driver</h2><h3 id="installation">Installation</h3><p><a href="https://www.if-not-true-then-false.com/2015/fedora-nvidia-guide/">This tutorial</a> covers majority of the installation process, but I’ll detail here what went wrong.</p><h3 id="issues">Issues</h3><ul><li><code class="language-plaintext highlighter-rouge">ERROR: could not insert 'nvidia_drm': Operation not permitted</code>.</li></ul><p>Disabling Secure Boot and SELinux while installing the driver fixed this problem. Providing the x509 cert and key created before to the NVidia installer did not help. I had to disable Secure Boot and sign it manually later.</p><ul><li>Wrong resolution</li></ul><p><code class="language-plaintext highlighter-rouge">xrandr -q</code> was showing <code class="language-plaintext highlighter-rouge">eDP-1-1 primary connected 960x540+0+0</code>. My monitor is 1080p. To fix that, I tried several different things, like setting the Mode manually inside the <code class="language-plaintext highlighter-rouge">xorg.conf</code>, setting the DPI, extracting the EDID using NVidia tools, disable EDID usage, <code class="language-plaintext highlighter-rouge">xrandr</code> with different combinations, and several variations inside the <code class="language-plaintext highlighter-rouge">Xorg.conf</code>, but nothing worked. In the end, it was just a matter of enabling <code class="language-plaintext highlighter-rouge">DPMS</code> and <a href="https://gist.github.com/kassner/7efbbf6c5bb56ec1270df31983bad617">my xorg.conf</a> now looks like this.</p><p>I also followed the <a href="https://forum.manjaro.org/t/howto-set-up-prime-with-nvidia-proprietary-driver/40225">scripting part of this tutoria</a>, but I am not sure if this is doing anything for me right now. I also have the xrandr lines on my <code class="language-plaintext highlighter-rouge">~/.profile</code>.</p><h3 id="secure-boot">Secure Boot</h3><p>I disabled Secure boot while installing the Nvidia driver, but later I enabled it back. It was less difficult than I expected. I followed <a href="http://www.pellegrino.link/2015/11/29/signing-nvidia-proprietary-driver-on-fedora.html">this tutorial from Laurent</a>, but I am writing here it again for backup AND because I didn’t find the <code class="language-plaintext highlighter-rouge">.ko</code> files in the first place (because they were compressed).</p><p>First off, I had to generate some keys and add them to the Secure Boot mechanism, otherwise UEFI wouldn’t be able to know if the modules it is loading are trusted or not. For that, I needed a configuration file, which I created at <code class="language-plaintext highlighter-rouge">~/x509.ini</code> with the content:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[req]
default_bits = 4096
distinguished_name = req_distinguised_name
prompt = no
string_mask = utf8only
x509_extensions = myexts

[req_distinguised_name]
O = kassner
CN = kassner
emailAddress = email@example.com

[myexts]
basicConstraints=critical,CA:FALSE
keyUsage=digitalSignature
subjectKeyIdentifier=hash
authorityKeyIdentifier=keyid
</code></pre></div></div><p>Then:</p><ol><li><code class="language-plaintext highlighter-rouge">openssl req -x509 -new -nodes -utf8 -sha256 -days 36500 -batch -config x509.ini -outform DER -out public_key.der -keyout private_key.priv</code>;</li><li><code class="language-plaintext highlighter-rouge">mokutil --import public_key.der</code>;</li><li>Reboot and follow the instructions to import the certificate;</li></ol><p>And to sign the NVidia drivers:</p><ol><li><code class="language-plaintext highlighter-rouge">find / -name 'nvidia.ko.xz'</code>. The other files were in the same folder;</li><li>Backup them somewhere else;</li><li><code class="language-plaintext highlighter-rouge">xz --decompress *.ko.xz</code>;</li><li><code class="language-plaintext highlighter-rouge">/usr/src/kernels/$(uname -r)/scripts/sign-file sha256 ~/private_key.priv ~/public_key.der nvidia.ko</code> and for the other <code class="language-plaintext highlighter-rouge">.ko</code> files;</li><li><code class="language-plaintext highlighter-rouge">xz --compress nvidia.ko</code> and the other <code class="language-plaintext highlighter-rouge">.ko</code> files as well;</li><li><code class="language-plaintext highlighter-rouge">modinfo nvidia</code> to be sure they are working;</li></ol><h2 id="language-keyboard-locale-etc">Language, keyboard, locale, etc</h2><p>I have a weird keyboard and language combination that I had to address for this computer. My computer has a Swedish keyboard, with the <code class="language-plaintext highlighter-rouge">ä ö å</code> keys. I have an USB keyboard that shares the same layout. But, I was raised with a US keyboard and I do write Portuguese every day as well, so writing letters like <code class="language-plaintext highlighter-rouge">é ç ã</code> is essential for me. At the same time, I rather use the US keyboard layout instead, since my muscle memory is already built around it. To orchestrate all this mess, I spent several days trying out different things until I finally managed.</p><p>Sadly, since it was so scattered around and I couldn’t remember everything I did, I am most likely missing some things here. I am writing what I remember and I’ll update in the future if I ever find out what is wrong.</p><h3 id="dates">Dates</h3><p><code class="language-plaintext highlighter-rouge">date</code> and some other parts of some apps were returning localized information for me in Swedish. This was mainly due the fact that only <code class="language-plaintext highlighter-rouge">$LANG</code> was set to <code class="language-plaintext highlighter-rouge">en_US.UTF-8</code> and all other variables were set to <code class="language-plaintext highlighter-rouge">sv_SE.UTF-8</code>, because I selected <code class="language-plaintext highlighter-rouge">English</code> as language and <code class="language-plaintext highlighter-rouge">Sweden (English)</code> as format.</p><p>To fix this, I tried several different things, and what I believe it worked was:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo localedef -v -c -i en_US -f UTF-8 en_SE.UTF-8
sudo localectl set-locale LANG=en_SE.UTF-8
</code></pre></div></div><p>And keep my <code class="language-plaintext highlighter-rouge">/etc/locale.conf</code> like this:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LANG=en_SE.UTF-8
LC_CTYPE="en_SE.UTF-8"
LC_NUMERIC="en_SE.UTF-8"
LC_TIME="en_SE.UTF-8"
LC_COLLATE="en_SE.UTF-8"
LC_MONETARY="en_SE.UTF-8"
LC_MESSAGES="en_SE.UTF-8"
LC_PAPER="en_SE.UTF-8"
LC_NAME="en_SE.UTF-8"
LC_ADDRESS="en_SE.UTF-8"
LC_TELEPHONE="en_SE.UTF-8"
LC_MEASUREMENT="en_SE.UTF-8"
LC_IDENTIFICATION="en_SE.UTF-8"
LC_ALL=
</code></pre></div></div><h3 id="compose">Compose</h3><p>I copied from <code class="language-plaintext highlighter-rouge">/usr/share/X11/locale/en_US.UTF-8/Compose</code> to <code class="language-plaintext highlighter-rouge">~/.XCompose</code> and applied the following diff.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--- Compose	2018-06-23 21:37:15.647432197 +0200
+++ .XCompose	2018-06-23 22:19:59.832729155 +0200
@@ -611,7 +611,7 @@
 &lt;Multi_key&gt; &lt;asterisk&gt; &lt;A&gt; 		: "Å"   Aring # LATIN CAPITAL LETTER A WITH RING ABOVE
 &lt;Multi_key&gt; &lt;A&gt; &lt;asterisk&gt; 		: "Å"   Aring # LATIN CAPITAL LETTER A WITH RING ABOVE
 &lt;Multi_key&gt; &lt;A&gt; &lt;A&gt; 			: "Å"   Aring # LATIN CAPITAL LETTER A WITH RING ABOVE
-&lt;dead_cedilla&gt; &lt;C&gt;               	: "Ç"   Ccedilla # LATIN CAPITAL LETTER C WITH CEDILLA
+&lt;dead_acute&gt; &lt;C&gt;               	: "Ç"   Ccedilla # LATIN CAPITAL LETTER C WITH CEDILLA
 &lt;Multi_key&gt; &lt;comma&gt; &lt;C&gt;          	: "Ç"   Ccedilla # LATIN CAPITAL LETTER C WITH CEDILLA
 &lt;Multi_key&gt; &lt;C&gt; &lt;comma&gt; 		: "Ç"   Ccedilla # LATIN CAPITAL LETTER C WITH CEDILLA
 &lt;Multi_key&gt; &lt;cedilla&gt; &lt;C&gt;          	: "Ç"   Ccedilla # LATIN CAPITAL LETTER C WITH CEDILLA
@@ -736,7 +736,7 @@
 &lt;Multi_key&gt; &lt;asterisk&gt; &lt;a&gt; 		: "å"   aring # LATIN SMALL LETTER A WITH RING ABOVE
 &lt;Multi_key&gt; &lt;a&gt; &lt;asterisk&gt; 		: "å"   aring # LATIN SMALL LETTER A WITH RING ABOVE
 &lt;Multi_key&gt; &lt;a&gt; &lt;a&gt; 			: "å"   aring # LATIN SMALL LETTER A WITH RING ABOVE
-&lt;dead_cedilla&gt; &lt;c&gt;               	: "ç"   ccedilla # LATIN SMALL LETTER C WITH CEDILLA
+&lt;dead_acute&gt; &lt;c&gt;               	: "ç"   ccedilla # LATIN SMALL LETTER C WITH CEDILLA
 &lt;Multi_key&gt; &lt;comma&gt; &lt;c&gt;          	: "ç"   ccedilla # LATIN SMALL LETTER C WITH CEDILLA
 &lt;Multi_key&gt; &lt;c&gt; &lt;comma&gt; 		: "ç"   ccedilla # LATIN SMALL LETTER C WITH CEDILLA
 &lt;Multi_key&gt; &lt;cedilla&gt; &lt;c&gt;          	: "ç"   ccedilla # LATIN SMALL LETTER C WITH CEDILLA
@@ -873,11 +873,9 @@
 &lt;Multi_key&gt; &lt;a&gt; &lt;semicolon&gt;      	: "ą"   U0105 # LATIN SMALL LETTER A WITH OGONEK
 &lt;Multi_key&gt; &lt;comma&gt; &lt;a&gt;         	: "ą"   U0105 # LATIN SMALL LETTER A WITH OGONEK
 &lt;Multi_key&gt; &lt;a&gt; &lt;comma&gt; 		: "ą"   U0105 # LATIN SMALL LETTER A WITH OGONEK
-&lt;dead_acute&gt; &lt;C&gt;                 	: "Ć"   U0106 # LATIN CAPITAL LETTER C WITH ACUTE
 &lt;Multi_key&gt; &lt;acute&gt; &lt;C&gt;          	: "Ć"   U0106 # LATIN CAPITAL LETTER C WITH ACUTE
 &lt;Multi_key&gt; &lt;apostrophe&gt; &lt;C&gt;     	: "Ć"   U0106 # LATIN CAPITAL LETTER C WITH ACUTE
 &lt;Multi_key&gt; &lt;C&gt; &lt;apostrophe&gt; 		: "Ć"   U0106 # LATIN CAPITAL LETTER C WITH ACUTE
-&lt;dead_acute&gt; &lt;c&gt;                 	: "ć"   U0107 # LATIN SMALL LETTER C WITH ACUTE
 &lt;Multi_key&gt; &lt;acute&gt; &lt;c&gt;          	: "ć"   U0107 # LATIN SMALL LETTER C WITH ACUTE
 &lt;Multi_key&gt; &lt;apostrophe&gt; &lt;c&gt;     	: "ć"   U0107 # LATIN SMALL LETTER C WITH ACUTE
 &lt;Multi_key&gt; &lt;c&gt; &lt;apostrophe&gt; 		: "ć"   U0107 # LATIN SMALL LETTER C WITH ACUTE
</code></pre></div></div><p>Weirdly, my current <code class="language-plaintext highlighter-rouge">/usr/share/X11/locale/en_US.UTF-8/Compose</code> has no difference to my .XCompose, so I am not sure which one was the modification that made the trick.</p><h3 id="keyboard">Keyboard</h3><p>The keyboard layout <code class="language-plaintext highlighter-rouge">English (intl., with dead keys)</code> works as expected in (almost) all apps. <code class="language-plaintext highlighter-rouge">~ + C</code> gives me <code class="language-plaintext highlighter-rouge">ç</code> as <code class="language-plaintext highlighter-rouge">' + e</code> gives me <code class="language-plaintext highlighter-rouge">é</code>. Except PhpStorm. I can’t successfully type <code class="language-plaintext highlighter-rouge">" ' ~ </code> or the backtick within the editor. Just nothing gets typed. The PhpStorm Keymap settings can recognize when I type one of those keys, but the editor itself or other menus wouldn’t. I tried several different things, related with IBus, changing <code class="language-plaintext highlighter-rouge">XMODIFIERS</code>, <code class="language-plaintext highlighter-rouge">/etc/environment</code>, <code class="language-plaintext highlighter-rouge">~/.Xmodmap</code> and <code class="language-plaintext highlighter-rouge">~/.profile</code>, saw some bug reports on JetBrains tracker, but nothing really worked.</p><p>My current workaround is to have <code class="language-plaintext highlighter-rouge">English (intl, with AltGr dead keys)</code> as a second keyboard layout that I use while I am on PhpStorm. Since I only write code (and comments) in English, it won’t be much of a problem, but I am having occasional mindfucks because I’ll keep forgetting to switch between keyboard layouts when I switch applications.</p></div><div class="entry-footer"><p class="cat-links">Posted in <a href="/tags/linux/" rel="tag">linux</a></p></div> </article> </main></div></div></div><footer><div class="footer-content"></div><div class="footer"><div><div> <span class="copy">Copyright © 2010-2021 Rafael Kassner</span></div></div></div> </footer></body></html>