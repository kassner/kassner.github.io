<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta charset="UTF-8"><title>Profiling browser requests with Blackfire | Rafael Kassner</title><meta name="robots" content="index,follow"/><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://www.kassner.com.br/atom.xml"/><link rel="canonical" href="https://www.kassner.com.br/en/2017/06/16/profiling-browser-requests-with_blackfire/"/><link rel="stylesheet" href="https://www.kassner.com.br/assets/css/main.css"/></head><body class="post"><div class="background"></div><div id="wrapper"> <header> <nav id="site-navigation" class="main-navigation" role="navigation"> <label for="drop" class="toggle">Menu</label> <input type="checkbox" id="drop"/><ul id="primary-menu" class="menu"><li class="menu-item"><a href="https://www.kassner.com.br">Rafael Kassner</a></li><li class="menu-item"><a href="https://www.kassner.com.br/projects/">Projects</a></li><li class="menu-item"><a href="https://www.kassner.com.br/about/">About</a></li></ul> </nav> </header><div class="pull-down"></div><div class="container"><div id="primary" class="content-area"> <main id="main" class="site-main" role="main"> <article lang="en" class="post type-post status-publish format-standard hentry"><h1 class="article-header"><a href="https://www.kassner.com.br/en/2017/06/16/profiling-browser-requests-with_blackfire/">Profiling browser requests with Blackfire</a></h1><div class="entry-meta"><div class="byline"> <span class="posted-on"><time class="entry-date published" datetime="2017-06-16T00:00:00+00:00">2017-06-16</time></span> <span class="language">English</span></div></div><div class="entry-content"><p>This week’s task was optimising Magento for large carts (100+ different products) and a profiler is a good tool to find small pieces of code that could be optimised. <a href="https://www.blackfire.io/">Blackfire</a> was my choice, mostly because previous experience, but also because it is not a resource hog like Xdebug, which was taking around 6 minutes while Blackfire took only 20 seconds in the same type of request.</p><h2 id="companion">Companion</h2><p>Blackfire works great to profile GET requests on the browser with the help of <a href="https://blackfire.io/docs/integrations/chrome">Companion</a>, but it doesn’t allow you to profile POST requests. Also, Companion sends multiple requests to the same endpoint, but Magento’s place order is not stateless, so the first and all other request would differ substantially.</p><h2 id="cli-tool">CLI tool</h2><p>Second attempt was the Blackfire <a href="https://blackfire.io/docs/cookbooks/profiling-http">CLI tool</a>, which allows you to profile anything you can reach with <code class="language-plaintext highlighter-rouge">curl</code>, including POST requests and custom headers. But, you can only profile one request at the given time, so that means I need to assemble one HTTP call that does everything: login customer, add products to cart, collect totals, get shipment information, get payment information, save shipping, save payment, and finally place order. That way I am profiling a lot more than I need, not to mention that everything will be in the same requests and not have the same performance as the end customer will experience, since a lot of objects will have been cached in memory when the place order part is executed. So I ruled that out too.</p><h2 id="xdebug">Xdebug</h2><p>Xdebug does exactly what I want, but takes too much time, being almost impractical. You can enable the profiling for any HTTP request, so that wouldn’t be a problem, I just use my browser and to navigate through all the needed steps (I can even do that with Xdebug disabled and enable only for the last step) and then analyse the cachegrind files. But Xdebug uses too much resources, I was hitting a 5-minute timeout on FPM too easily and the results were contaminated by the slowness (everything was slower in a factor of ~5 compared to the latest Blackfire result).</p><p>One nice tip here: you can use <code class="language-plaintext highlighter-rouge">blackfire upload</code> to send the Xdebug output files to Blackfire and see the analysis there, I am pretty amazed by that feature. Way to go SensioLabs!</p><h2 id="custom-headers">Custom headers</h2><p>With a bit of back and forth with SensioLabs support I was able to achieve what I wanted, even if requires a bit more work.</p><h3 id="requirements">Requirements</h3><ol><li>Extension for your browser to modify the request headers (I used <a href="https://chrome.google.com/webstore/detail/modheader/idgpnmonknjnojddfkpgkljpfnnfcklj?hl=en">ModHeader</a> for Google Chrome);</li><li>Blackfire CLI tool;</li><li>Blackfire configured on the webserver;</li></ol><h3 id="steps">Steps</h3><ol><li>Do all the preparation needed. I added all products to the cart, navigated to checkout page and filled all the information, only leaving out the ‘click on place order button’ step;</li><li>Run <code class="language-plaintext highlighter-rouge">blackfire run env</code> and copy the value of the <code class="language-plaintext highlighter-rouge">BLACKFIRE_QUERY</code> outputted variable;</li><li><p>Using the browser extension, add the following headers to your request (<a href="http://i.imgur.com/QMjadko.png">example</a>):</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>X-Blackfire-User-Agent: Blackfire Companion - Chrome/58.0.3029.110 Extension/1.10.0
X-Blackfire-Query: [the value copied on #2]
</code></pre></div></div></li><li>Execute your request (click the place order button).</li><li><a href="http://i.imgur.com/kIU3epD.png">Profit</a>.</li></ol><p>With those steps, the first AJAX/POST request (that reaches PHP) with those headers will be profiled. <em>It only works once</em>, so it will not profile the success page (which is the one the request I profiled redirects to). Every new request needs a new <code class="language-plaintext highlighter-rouge">X-Blackfire-Query</code> header, so with this approach is not (yet) possible to profile the redirected page as well or other subsequent calls inside the same page.</p><p>If the request you want to profile is not the first one that you are able to fire, instead of using the extension on the browser, change your Javascript code to include those headers only for the request you need (or keep the extension but change the Javascript to remove them).</p><h2 id="what-i-have-not-tried">What I have not tried</h2><p>There are two other ways that I could profile what I wanted with Blackfire, but I haven’t tested:</p><ol><li><p>Use the <a href="https://blackfire.io/docs/reference-guide/php-sdk">PHP SDK</a> and start/stop the profiling on the areas that you need. It sounds like is something that will work, but that means you need to do some changes on code. I would only go that route if I hadn’t found any alternative.</p></li><li><p>Using the scenario I described on the <a href="#cli-tool">CLI tool</a>, but using the technic presented on <a href="https://blog.blackfire.io/profiling-http-sub-requests-using-blackfire.html">Profiling HTTP Sub-Requests using Blackfire</a>. To achieve I would had to assemble all the HTTP calls as the same way as Magento would have done, and send the <code class="language-plaintext highlighter-rouge">X-Blackfire-Query</code> header with them. This will profile all the calls individually (thus not having the <em>in-memory cache</em> problem), but it also requires a bit of coding, or preparing all the HTTP requests manually to some degree.</p></li></ol><h2 id="conclusion">Conclusion</h2><p>Blackfire is a nice tool and I really like the help their support provided here. I wish they cover this edge case in their roadmap, but after this <em>discovery</em> I am definitely not turning it down, I am very happy with the results. Please consider giving Blackfire a try if you need it.</p></div><div class="entry-footer"><p class="cat-links">Posted in <a href="/tags/php/" rel="tag">php</a>, <a href="/tags/magento/" rel="tag">magento</a>, <a href="/tags/testing/" rel="tag">testing</a></p></div> </article> </main></div></div></div><footer><div class="footer-content"></div><div class="footer"><div><div> <span class="copy">Copyright © 2010-2021 Rafael Kassner</span></div></div></div> </footer></body></html>